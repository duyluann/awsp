name: CI

on:
  push:
  pull_request:

jobs:
  lint-and-test:
    runs-on: ubuntu-24.04

    env:
      # Use a throwaway HOME so we don't touch the runner's default dotfiles
      TEST_HOME: ${{ github.workspace }}/.testhome

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies (shellcheck, zsh)
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck zsh

      - name: Lint shell scripts
        run: |
          # Lint the main function and completions
          shellcheck -x bin/awsp.sh || (echo "shellcheck failed" && exit 1)
          # completions can be shellchecked too, but zsh files may warn on zshisms; ignore them if needed
          shellcheck -x completions/awsp.bash || (echo "shellcheck failed (bash completion)" && exit 1)

      - name: Prepare isolated HOME and mock aws
        run: |
          set -euo pipefail
          mkdir -p "$TEST_HOME/bin"
          mkdir -p "$TEST_HOME/.config"
          # Mock aws CLI to simulate profiles + sts + sso login
          cat > "$TEST_HOME/bin/aws" <<'EOS'
          #!/usr/bin/env bash
          set -euo pipefail
          case "${1-} ${2-} ${3-}" in
            "configure list-profiles"*)
              echo "dev-admin"
              echo "qa"
              echo "prod"
              ;;
            "sts get-caller-identity"*)
              # If --output json is requested, emit JSON; else print something
              if printf ' %s ' "$@" | grep -q -- '--output json'; then
                printf '{"UserId":"ABCDEF123","Account":"123456789012","Arn":"arn:aws:sts::123456789012:assumed-role/dev-admin/user"}\n'
              else
                printf '+----------------+------------------+--------------------------------------------------+\n'
                printf '|     UserId     |      Account     |                        Arn                       |\n'
                printf '+----------------+------------------+--------------------------------------------------+\n'
                printf '| ABCDEF123      | 123456789012     | arn:aws:sts::123456789012:assumed-role/dev-admin |\n'
                printf '+----------------+------------------+--------------------------------------------------+\n'
              fi
              ;;
            "sso login"*)
              echo "SSO login OK"
              ;;
            *)
              # Default passthrough message so failures are obvious
              echo "mock aws: unhandled args: $*" >&2
              exit 0
              ;;
          esac
          EOS
          chmod +x "$TEST_HOME/bin/aws"

      - name: Test in Bash
        shell: bash
        run: |
          set -euo pipefail
          export HOME="$TEST_HOME"
          export PATH="$TEST_HOME/bin:$PATH"

          # Sanity: versions
          bash --version | head -n1
          shellcheck --version | head -n1
          aws configure list-profiles

          # Install to ~/.config/awsp (Makefile default)
          make install

          # The installer added a source line to rc files; source directly now
          . "$HOME/.config/awsp/awsp.sh"

          # 1) Help
          awsp -h >/dev/null

          # 2) List
          out="$(awsp -l)"
          echo "$out"
          grep -q dev-admin <<<"$out"
          grep -q qa <<<"$out"

          # 3) Switch profile without verify (no noisy output)
          awsp --no-verify qa -q
          test "${AWS_PROFILE:-}" = "qa"
          test "${AWS_DEFAULT_PROFILE:-}" = "qa"

          # 4) Force login, then verify with json
          awsp -L -v --json qa | grep -q '"Account": "123456789012"'

          # 5) Unset
          awsp -u
          test -z "${AWS_PROFILE:-}"

          # 6) Uninstall cleans files and rc entries
          make uninstall
          test ! -d "$HOME/.config/awsp"

          # rc files should not contain sourcing lines
          for rc in "$HOME/.bashrc" "$HOME/.bash_profile" "$HOME/.profile" "$HOME/.zshrc" "$HOME/.zprofile"; do
            [ -f "$rc" ] || continue
            ! grep -q '\.config/awsp/awsp.sh' "$rc"
          done

      - name: Test in Zsh
        shell: bash
        run: |
          set -euo pipefail
          export HOME="$TEST_HOME"
          export PATH="$TEST_HOME/bin:$PATH"

          # Re-install for zsh test
          make install

          # Run a zsh login-like shell that sources rc and exercises awsp
          zsh -lc '
            set -euo pipefail
            # ensure awsp is loaded from rc line
            type awsp >/dev/null 2>&1 || source "$HOME/.config/awsp/awsp.sh"
            awsp -l | grep -q dev-admin
            awsp --no-verify prod -q
            [[ "$AWS_PROFILE" == "prod" ]]
            awsp -u
            [[ -z "${AWS_PROFILE:-}" ]]
          '

          # Cleanup
          make uninstall
